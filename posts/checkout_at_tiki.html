<html>
    <head>
        <title> Checkout at Tiki | Blog</title>
        <meta charset="utf-8">
        <meta http-equiv="content-type" content="text/html;"><meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
        
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,300&subset=latin,vietnamese' rel='stylesheet' type='text/css'>
        <link href="../css/theme.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="../css/highlight/tomorrow-night.css">
        <link rel="stylesheet" href="../css/fontello.css">
        <script src="../js/highlight.pack.js"></script>
        <script>
        hljs.initHighlightingOnLoad();
        </script>
    </head>
    <body>
        <div class="header">
            <a href="/"><i class="icon icon-emo-coffee"></i> Blog</a>
        </div>
        <div class="container">
            <div class="main">
                <h1 id="checkout-at-tiki">Checkout at Tiki</h1>
<p>Vậy là sau hơn 1,5 năm gắn bó và làm việc ở Tiki ở vị trí Software Engineer (SE) cụ thể hơn là Back-End Engineer thuộc Checkout and Payment team. Đây là bài blog đầu tiên của mình sẽ chia sẻ business và technical của một hệ thống lớn E-Commerce ở Việt Nam về các vấn đề Cart Processing, Promotion, Payment, Deal Processing, Order Routing, Order Processing.</p>
<p>Vì bài viết này khá dài nên mình sẽ update thường xuyên, rất mong các bạn thông cảm.</p>
<h2 id="1-checkout">1. Checkout</h2>
<p> Có thể hiểu đơn giản Checkout &amp; Payment là một flow đi từ lúc bạn add sản phẩm vào giỏ hàng và thanh toán, đây cũng chính là thành phần quan trọng nhất trong một hệ thống E-Commerce. Dưới đây là checkout flow ở Tiki:</p>
<p> <img src="../img/checkout_flow_at_tiki.png" alt="Checkout Flow Detail at Tiki"></p>
<p> Chính vì vậy Checkout phải đáp ứng các requirement sau:</p>
<ul>
<li>Single responsibility, high availability, low latency.</li>
<li>Scaleable, reuseable, extendable, maintainable.</li>
<li>Support non-blocking, asynchronous, muli-threaded when needed.</li>
<li>Well-tested.</li>
<li>Consistency</li>
</ul>
<p><strong>To be continued</strong></p>
<p>---#### Cart Processing</p>
<p>Cart Processing là một component cực kỳ phức tạp bao gồm: insert/update/delete sản phẩm, tính toán và apply promotion.</p>
<h5 id="cart-info">Cart Info</h5>
<p>Các bạn có bao giờ bạn add sản phẩm vào giỏ hàng và rất lâu sau đó 1 ngày hoặc có thể 1 tháng bạn vào lại giỏ hàng mà vẫn nhìn thấy sản phẩm trong giỏ hàng vẫn còn y nguyên? Có hai cách là lưu giỏ hàng xuống một RDBMS hoặc NoSQL và ở Tiki đã và đang dùng hai cách trên.</p>
<p>RDBMS: Tiki đã từng dùng MySQL để lưu cart info (product, shipping address, payment info) nhưng do số lượng write và read quá cao khi customer request get cart info hệ thống sẽ tính toán lại và update lại vào DB điều đó làm cho hệ thống không thể scaleable.</p>
<p>NoSQL: Tiki hiện tại đang dùng MongoDB để lưu info của cart. Vì sao Tiki lại dùng MongoDB để lưu thì mình nói trong một bài viết khác.</p>
<h5 id="promotion">Promotion</h5>
<p>Promotion ở Tiki rất là complex vì không chỉ đơn giản là apply coupon xong nhận được discount mà có thể nhập coupon vừa được discount vừa được free gift, hoặc sản phẩm đó được tặng gift nào.</p>
<p>Khi user request get cart info, hệ thống sẽ lấy ra những tất cả promotion nào đang active đang chạy (Redis or MySQL) và chạy qua một bộ validator để validate cart của customer có đủ điều kiện để apply những promotion không có coupon hay không.</p>
<h4 id="payment">Payment</h4>
<p>Có thể nói đây chính là phần quan trọng của Checkout &amp; Payment vì liên quan đến tiền bạc, mà đã dính đến tiền bạc thì có rất nhiều vấn đề xảy ra nếu như hệ thống xử lý không tốt. Vì thế phải đáp ứng đủ các yêu cầu sau:</p>
<ul>
<li>Extendable</li>
<li>Consistency</li>
</ul>
<!-- Bạn muốn mua một hay nhiều sản phẩm cùng lúc? Việc của bạn là cần add sản phẩm đó vào cart để mua hàng, nhưng bạn lại không muốn mua ngay lúc đó mà vài ngày sau bạn quay lại mua các sản phẩm đó mà lúc trước bạn đã add vào cart. Nhưng thật không may các sản phẩm mà bạn đã add trước đó đều đã mất. Để giải quyết vần đề trên thì có các solution sau:

Dùng DBMS: Lúc trước ở Tiki bọn mình dùng MySQL để save những gì trong cart của bạn (product, shipping address, selected payment) nhưng bọn mình gặp phải cấn vấn đề khi số lượng CCU quá cao như những lúc chạy deal, event quá hot dẫn đến việc write (add, update,remove product ở cart) vào master db quá cao (ở Tiki bọn mình dùng master - slave) và do một phần code trước đó đều select lại cart từ con master dẫn đến con master chịu tải không nỗi.

Dùng MongoDB: Đây là solution hiện tại bọn mình vẫn đang dùng đến hiện tại, tại sao bọn mình lại chọn MongoDB mà không phải Redis, Memcached hay một thứ gì đó persist on disk. -->

            </div>
        </div>
	    <div class="footer">
            <p>Created with <a href="http://github.com/huytd/azeroth-js">azeroth.js</a></p>
            <div class="social">
                <a href="#"><i class="icon-facebook-squared"></i></a>
                <a href="#"><i class="icon-twitter-squared"></i></a>
                <a href="#"><i class="icon-linkedin-squared"></i></a>
                <a href="#"><i class="icon-github-squared"></i></a>
                <a href="#"><i class="icon-mail-alt"></i></a>
            </div>
        </div>
        <script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea"]
          }
        });
        </script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'Insert-Your-GA-ID-Here', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
